<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">

<dom-module id="chromedash-userlist">
<link rel="import" rel="css" href="../css/elements/chromedash-userlist.css">
<template>
  <form id="form" name="user_form" method="post" action="{{action}}" onsubmit="return false;">
    <table>
      <tr>
        <td><input type="email" placeholder="Email address" name="email" id="id_email" required></td>
        <td><input type="submit" on-tap="ajaxSubmit"></td>
      </tr>
    </table>
  </form>
  <hr>
  <ul id="user-list">
    <template is="dom-repeat" items="{{users}}" as="user">
      <li>
        <a href$="{{computeDeleteHref(action, user)}}" on-tap="ajaxDelete">delete</a><span>{{user.email}}</span>
      </li>
    </template>
  </ul>
</template>
</dom-module>
<script>
  Polymer({
    is: 'chromedash-userlist',
    properties: {
      action: {
        type: String
      },
      users: {
        type: Array,
        value: function () { return []; },
        notify: true
      }
    },
    computeDeleteHref: function(action, user) {
      return action + '/' + user.id;
    },
    addUser: function (user) {
      this.users.splice(0, 0, user);
    },
    removeUser: function (idx) {
      return this.users.splice(idx, 1);
    },
    ajaxSubmit: function (e, details, sender) {
      e.preventDefault();
      if (this.$.form.checkValidity()) {
        // TODO(ericbidelman): move back to this.$.form.email.value when SD
        // polyfill merges the commit that wraps element.form.
        var email = this.$.form.querySelector('input[name="email"]').value;
        var formData = new FormData();
        formData.append('email', email);
        var xhr = document.createElement('iron-request');
        xhr.send({
          url: this.action,
          method: 'POST',
          body: formData
        }).then(function (request) {
          if (request.status == 201) {
            this.addUser(JSON.parse(response));
            this.$.form.reset();
          } else if (request.status == 200) {
            alert('Thanks. But that user already exists');
          }
        }.bind(this));
      }
    },
    ajaxDelete: function (e, details, sender) {
      e.preventDefault();
      if (!confirm('Remove user?')) {
        return;
      }  // Get index of user model instance that was clicked from template.
      // Get index of user model instance that was clicked from template.
      var user = e.target.templateInstance.model.user;
      var idx = this.users.indexOf(user);
      var xhr = document.createElement('iron-request');
      xhr.request({
        url: sender.href,
        method: 'POST'
      }).then(function (request) {
        e.target.parentElement.classList.add('faded');
        if ('ontransitionend' in window) {
          var li = sender.parentElement;
          li.addEventListener('transitionend', function (e) {
            this.removeUser(idx);
          }.bind(this));
          li.classList.add('faded');
        } else {
          this.removeUser(idx);
        }
      }.bind(this));
    }
  });
</script>


<!-- <link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-request.html">

<polymer-element name="chromedash-userlist" attributes="users action">
<template>
  <link rel="stylesheet" href="../css/elements/chromedash-userlist.css">
  <form id="form" name="user_form" method="post" action="{{action}}" onsubmit="return false;">
    <table>
      <tr>
        <td><input type="email" placeholder="Email address" name="email" id="id_email" required></td>
        <td><input type="submit" on-tap="{{ajaxSubmit}}"></td>
      </tr>
    </table>
  </form>
  <hr>
  <ul id="user-list">
    <template repeat="{{user in users}}">
      <li>
        <a href="{{action}}/{{user.id}}" on-tap="{{ajaxDelete}}">delete</a><span>{{user.email}}</span>
      </li>
    </template>
  </ul>
</template>
<script>
Polymer({
  is: 'chromedash-userlist',
  properties: {
    action: {
      type: String
    },
    users: {
      type: Array,
      value: function() { return []; },
      notify: true
    }
  },
  addUser: function(user) {
    this.users.splice(0, 0, user);
  },
  removeUser: function(idx) {
    return this.users.splice(idx, 1);
  },
  ajaxSubmit: function(e, details, sender) {
    e.preventDefault();

    if (this.$.form.checkValidity()) {
      // TODO(ericbidelman): move back to this.$.form.email.value when SD
      // polyfill merges the commit that wraps element.form.
      var email = this.$.form.querySelector('input[name="email"]').value;

      var formData = new FormData();
      formData.append('email', email);

      var xhr = document.createElement('iron-request');
      xhr.send({url: this.action, method: 'POST', body: formData}).then(function(request) {
        if (request.status == 201) {
          this.addUser(JSON.parse(response));
          this.$.form.reset();
        } else if (request.status == 200) {
          alert('Thanks. But that user already exists');
        }
      }.bind(this));
    }
  },
  ajaxDelete: function(e, details, sender) {
    e.preventDefault();

    if (!confirm('Remove user?')) {
      return;
    }

    // Get index of user model instance that was clicked from template.
    var user = e.target.templateInstance.model.user;
    var idx = this.users.indexOf(user);

    var xhr = document.createElement('iron-request');
    xhr.send({url: sender.href, method: 'POST'}).then(function(request) {
      e.target.parentElement.classList.add('faded');

      if ('ontransitionend' in window) {
        var li = sender.parentElement;
        li.addEventListener('transitionend', function(e) {
          this.removeUser(idx);
        }.bind(this));
        li.classList.add('faded');
      } else {
        this.removeUser(idx);
      }
    }.bind(this));
  }
});
</script>
</polymer-element> -->
