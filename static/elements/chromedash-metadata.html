<link rel="import" href="polymer-elements/polymer-jsonp/polymer-jsonp.html">

<polymer-element name="chromedash-metadata" attributes="feature">
<template>
  <link rel="stylesheet" type="text/css" href="../css/elements/chromedash-metadata.css">
  <polymer-jsonp id="jsonp" url="//omahaproxy.appspot.com/all.json?callback=" auto></polymer-jsonp>
  <ul>
    <template repeat="{{v in versions}}">
      <li data-version="{{v}}" on-click="toggleMilestone" selected?="{{v == selected}}">{{v}}</li>
    </template>
  </ul>
</template>
<script>
  Polymer('chromedash-metadata', {
    applyAuthorStyles: true,
    selected: null,
    ready: function() {
      this.implStatuses = this.implStatuses || {};
      this.STATUS_KEYS = this.STATUS_KEYS || {};

      // TODO(ericbidelman): Share this data across instances.
      this.addEventListener('polymer-response', function(e) {
        var windowsVersions = e.detail.response[0];

        this.channels = {};

        for (var i = 0, el; el = windowsVersions.versions[i]; ++i) {
          // Include previous version if current is foobar'd.
          this.channels[el.channel] = parseInt(el.version) ||
                                      parseInt(el.prev_version);
        }

        // Dev channel explicitly left out. Treat same as canary.
        this.versions = [
          this.implStatuses[this.STATUS_KEYS.NO_ACTIVE_DEV - 1].val,
          this.implStatuses[this.STATUS_KEYS.PROPOSED - 1].val,
          this.implStatuses[this.STATUS_KEYS.IN_DEVELOPMENT - 1].val,
          this.channels.canary, this.channels.beta,
          this.channels.stable
        ];

        var NUM_VERSIONS_BACK = 6;
        var MIN_VERSION = this.channels.stable - NUM_VERSIONS_BACK
        for (var i = this.channels.stable - 1; i >= MIN_VERSION; i--) {
          this.versions.push(i);
        }

        //// Highlight the stable channel.
        //this.selected = this.IN_DEVELOPMENT;
      });

      //this.$.jsonp.go(); // Using auto attribute instead.
    },
    toggleMilestone: function(e, details, sender) {
      var version = sender.dataset.version;
      this.selected = this.selected == version ? null : version;
      // if (this.selected) {
      //   this.fire('filter-version', {val: '=' + version});
      // } else {
      //   this.fire('filter-version');
      // }
      // TODO: scroll to this milestone.
    }
  });
</script>
</polymer-element>
