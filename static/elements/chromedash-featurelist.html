<link rel="import" href="chromedash-feature.html">

<polymer-element name="chromedash-featurelist" attributes="whitelisted features">
<template>
  <link rel="stylesheet" type="text/css" href="../css/elements/chromedash-featurelist.css">
  <!-- <input type="search" placeholder="Search" on-keyup="filter"> -->
  <template repeat="{{feature in filtered}}">
    <li is="chromedash-feature" feature="{{feature}}">
      <template bind if="{{whitelisted}}">
        <a href="/admin/features/edit/{{feature.id}}" class="edit">edit</a>
      </template>
    </li>
  </template>
</template>
<script>
  Polymer('chromedash-featurelist', {
    applyAuthorStyles: true,
    whitelisted: false,
    ready: function() {
      this.asyncMethod(function() {
        this.features = this.features || [];
        this.filterd = this.filterd || [];
      });
    },
    featuresChanged: function() {
      this.filter();
    },
    filter: function(val) {
console.log('here')
      // Clear filter if there's no search or if called directly.
      if (!val) {
        this.filtered = this.features;
      } else {
        val = val.trim();

        // Returns operator and version query e.g. ["<=25", "<=", "25"].
        var result = /^([<>=]=?)\s*?([0-9]+)/.exec(val);
        if (result) {
          var operator = result[1];
          var version = parseInt(result[2]);
          this.filtered = this.features.filter(function(feature, idx, array) {
            var shipped_milestone = parseInt(feature.shipped_milestone);

            switch(operator) {
              case '<':
                return shipped_milestone < version;
                break;
              case '<=':
                return shipped_milestone <= version;
                break;
              case '>':
                return shipped_milestone > version;
                break;
              case '>=':
                return shipped_milestone >= version;
                break;
              case '=': // Support both '=' and '=='.
              case '==':
                return version == shipped_milestone;
                break;
              default:
                return false;
            }
          });
        } else {
          // Remove "=" prefix so "experimental"/"started" version queries
          // return results.
          if (val.indexOf('=') == 0) {
            val = val.substring(1);
          }
          var regex = new RegExp(val, 'ig');
          this.filtered = this.features.filter(function(feature, idx, array) {
            return regex.test(feature.name) || regex.test(feature.category) ||
                   regex.test(feature.summary) ||
                   regex.test(feature.shipped_milestone) ||
                   regex.test(feature.impl_status_chrome);
          });
        }
      }

      return this.filtered.length;
    }
  });
</script>
</polymer-element>