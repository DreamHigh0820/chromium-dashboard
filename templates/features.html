{% extends "base.html" %}

{% block html_imports %}
  <link rel="import" href="/static/elements/chromedash-featurelist.html">
  <link rel="import" href="/static/elements/chromedash-metadata.html">
{% endblock %}

{% block rss %}
<link href="features.xml" rel="alternate" type="application/rss+xml" title="All features" />
{% for k,v in categories %}
<link href="features.xml?category={{v}}" rel="alternate" type="application/rss+xml" title='"{{k}}" features' />
{% endfor %}

{% endblock %}

{% block css %}
<link rel="stylesheet" type="text/css" href="/static/css/features/features.css?2013-07-26">
{% endblock %}

{% block subheader %}
<div id="subheader">
  <div>
    <h2>Builds</h2>
  </div>
  <div>
    <h2>Features (<span id="num-features">-</span>)</h2>
  </div>
  <div class="search">
    <input type="search" placeholder="Search" disabled>
  </div>
  <div>
    {% if user.is_whitelisted %}
      <a href="/admin/features/new">Add a new feature</a>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block content %}
<section id="panels">
<nav>
  <chromedash-metadata></chromedash-metadata>
</nav>
<chromedash-featurelist {% if user.is_whitelisted %}whitelisted{% endif %}></chromedash-featurelist>
</section>

<!--
{% load verbatim %}
{% verbatim %}
{% endverbatim %} -->

{% endblock %}

{% block js %}
<script>
(function() {

function updateCount(count) {
  document.querySelector('#num-features').textContent = count;
}

var chromedashApp = document.querySelector('chromedash-featurelist');
document.addEventListener('WebComponentsReady', function(e) {
  // Fill data from server by including it directly in template.
  chromedashApp.features = {{features|safe}};

  // // Instead, fill data via AJAX.
  // var xhr = new XMLHttpRequest();
  // xhr.open('GET', '/features.json');
  // xhr.onloadend = function(e) {
  //   chromedashApp.features = JSON.parse(e.target.response);
  // };
  // xhr.send();

  updateCount(chromedashApp.features.length); // Set initial # features showing.

  var search = document.querySelector('.search [type="search"]');
  search.disabled = false;

  var chromeMetadata = document.querySelector('chromedash-metadata');
  chromeMetadata.addEventListener('filter-on-version', function(e) {
    search.value = e.detail.version;
    updateCount(chromedashApp.filter(e.detail.version));
  });

  // search.addEventListener('keyup', function(e) {
  //   e.stopPropagation();
  //   if (!e.target.value) {
  //     chromeMetadata.selected = null;
  //   }
  //   updateCount(chromedashApp.filter(e.target.value));
  // });

  // Clear input when user clicks the 'x' button.
  search.addEventListener('click', function(e) {
    if (!e.target.value) {
      updateCount(chromedashApp.filter());
      chromeMetadata.selected = null;
    }
  });

  document.body.addEventListener('keyup', function(e) {
    if (e.target == search) {
      if (!e.target.value) {
        chromeMetadata.selected = null;
      }
      updateCount(chromedashApp.filter(e.target.value));
    } else if (e.keyCode == 27) { // ESC
      updateCount(chromedashApp.filter());
      search.value = '';
      chromeMetadata.selected = null;
    }
  });
});

})();
</script>
{% endblock %}
