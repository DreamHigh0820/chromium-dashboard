{% extends "base.html" %}

{% block html_imports %}
<!--<link id="features_import"
        rel="import"
        href="/static/elements/admin-imports{% if VULCANIZE %}.vulcanize{% endif %}.html"
        async>-->
<link rel="import" href="/static/elements/common.html">
<link rel="import" href="/static/elements/chromestatus-icons.html">
<link rel="import" href="/static/bower_components/iron-icon/iron-icon.html">
{% endblock %}

{% block css %}
<style>
  /*.no-push-notifications {
    display: none;
  }*/
  body[data-path*='notifications/tester'] #spinner {
    display: none;
  }
</style>
{% endblock %}

{% block subheader %}
<div id="subheader">
 Push notification tester
</div>
{% endblock %}

{% block content %}
<iron-icon icon="chromestatus:notifications"></iron-icon>

<button onclick="sendNotification()" disabled class="no-push-notifications">Send message</button>
{% endblock %}

{% block js %}
<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/4.1.3/firebase-messaging.js"></script>

<script>
const SERVER_KEY = 'AAAA6Lfj0-8:APA91bFl7OgYBmIIOIJM-wW72FceMH0xBJpcRwT4PVyCg3LXNu7gvWZqz3OvXi2G5Jy6J7xreRSwUQus28hrkx_NOEoDBom9Gsci9qafcTUCvGdCliMbAEIksH4u9IFFofeOt7wANaQl';
const SUPPORTS_NOTIFICATIONS = navigator.serviceWorker && window.Notification;

firebase.initializeApp({
  apiKey: "AIzaSyDMfRkOLG6OUTeEL_Z2ixEMDceyklm10UM",
  authDomain: "cr-status.firebaseapp.com",
  databaseURL: "https://cr-status.firebaseio.com",
  projectId: "cr-status",
  storageBucket: "cr-status.appspot.com",
  messagingSenderId: "999517574127"
});

const messaging = firebase.messaging();

async function sendNotification() {
  if (!SUPPORTS_NOTIFICATIONS) {
    throw Error('You browser does not support push notifications');
  }

  const notification = {
    'title': 'Portugal vs. Denmark',
    'body': '5 to 1',
    'icon': '/static/img/crstatus_192.png',
    // 'badge': '/static/img/crstatus_192.png',
    // 'image': '/static/img/crstatus_192.png',
    'click_action': location.href
  };

  const token = await getToken();

  try {
    const resp = await fetch('https://fcm.googleapis.com/fcm/send', {
      method: 'POST',
      headers: {
        'Authorization': `key=${SERVER_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({notification, to: token})
    });
  } catch(err) {
    console.error('Error sending notification to FCM', err);
  }
}

async function requestNotifications() {
  try {
    await messaging.requestPermission();
  } catch (err) {
    console.error('Unable to get permission to notify.', err);
  }
  return Notification.permission === 'granted';
}

async function getToken() {
  let currentToken;
  try {
    // Get Instance ID token. Initially this makes a network call, once retrieved
    // subsequent calls to getToken will return from cache.
    currentToken = await messaging.getToken();
  } catch (err) {
    console.log('An error occurred while retrieving token. ', err);
    setTokenSentToServer(false);
    return;
  }

  if (currentToken) {
    sendTokenToServer(currentToken);
  } else {
    console.log('No Instance ID token available. Request permission to generate one.');
    // Prompt user to enable notifications.
    setTokenSentToServer(false);
    const granted = await requestNotifications();
    if (granted) {
      currentToken = await getToken();
    }
  }

  return currentToken;
}

// function deleteToken() {
//   // Delete Instance ID token.
//   // [START delete_token]
//   messaging.getToken()
//   .then(function(currentToken) {
//     messaging.deleteToken(currentToken)
//     .then(function() {
//       console.log('Token deleted.');
//       setTokenSentToServer(false);
//       // [START_EXCLUDE]
//       // Once token is deleted update UI.
//       // [END_EXCLUDE]
//     })
//     .catch(function(err) {
//       console.log('Unable to delete token. ', err);
//     });
//     // [END delete_token]
//   })
//   .catch(function(err) {
//     console.log('Error retrieving Instance ID token. ', err);
//   });
// }

function isTokenSentToServer() {
  return window.localStorage.getItem('pushTokenSentToServer') == 1;
}

function setTokenSentToServer(sent) {
  window.localStorage.setItem('pushTokenSentToServer', sent ? 1 : 0);
}

// Send the Instance ID token to the server, so we can:
// - send messages back to this app
// - subscribe/unsubscribe the token from topics
function sendTokenToServer(token) {
  if (!isTokenSentToServer()) {
    console.log('Sending token to server...');
    // TODO: Send the current token to your server.
    setTokenSentToServer(true);
  } else {
    console.log("Token already sent to server so won't send it again unless it changes");
  }
}

messaging.onTokenRefresh(async () => {
  let refreshedToken;
  try {
    // Get Instance ID token. Initially this makes a network call. Once
    // retrieved, subsequent calls to getToken will return from the cache.
    refreshedToken = await messaging.getToken();
  } catch (err) {
    console.error('Unable to retrieve refreshed token ', err);
    return;
  }

  console.log('Token refreshed.');
  setTokenSentToServer(false);
  sendTokenToServer(refreshedToken);
});

messaging.onMessage(payload => {
  const notification = new Notification(payload.notification.title, payload.notification);
  console.log(notification, payload);

  notification.onerror = function(e) {
    console.log(e);
  };

  notification.onclick = function(e) {
    //window.open(payload.notification.click_action, '_blank');
    window.focus();
  };
});

if (SUPPORTS_NOTIFICATIONS) {
  document.querySelectorAll('.no-push-notifications').forEach(el => {
    // el.classList.remove('no-push-notifications');
    el.disabled = false;
  });
  // navigator.serviceWorker.ready.then(reg => {
    // messaging.useServiceWorker(reg); // use site's existing sw instead of the one FB messaging registers.

    getToken().then(token => {
      console.log(token);
    });
  // });
}
</script>
{% endblock %}
